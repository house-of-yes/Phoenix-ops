#!/usr/bin/env bash
# Phoenix Ops Executor
# Purpose: Execute PHOENIX.ops by rebuilding MEMORY.state from canonical context
# Scope: Minimal v1 executor (hash + rebuild only)

set -euo pipefail

CMD="${1:-}"

if [[ "$CMD" != "ops" ]]; then
  echo "Usage: phoenix ops"
  exit 1
fi

ROOT="$(cd "$(dirname "$0")/.." && pwd)"
CTX="$ROOT/context"
MEM="$CTX/MEMORY.state"

required=(RIOT.act DYADS.yaml PHOENIX.ops MEMORY.state)

for f in "${required[@]}"; do
  [[ -f "$CTX/$f" ]] || { echo "Missing $CTX/$f"; exit 1; }
done

hash_file() {
  sha256sum "$1" | awk '{print $1}'
}

RIOT_HASH="$(hash_file "$CTX/RIOT.act")"
DYADS_HASH="$(hash_file "$CTX/DYADS.yaml")"
OPS_HASH="$(hash_file "$CTX/PHOENIX.ops")"
NOW="$(date -u +"%Y-%m-%dT%H:%M:%SZ")"

cat > "$MEM" <<EOF
# MEMORY.state v1.0
# Regenerated by Phoenix Ops executor

version: 1.0
updated: $NOW

state:
  status: READY
  last_reconstitution: $NOW

hashes:
  RIOT.act: "$RIOT_HASH"
  DYADS.yaml: "$DYADS_HASH"
  PHOENIX.ops: "$OPS_HASH"
EOF

echo "Phoenix Ops complete. State: READY"
